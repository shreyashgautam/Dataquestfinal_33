<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insider Threat Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .alert-high { background-color: #dc3545; color: white; }
        .alert-medium { background-color: #fd7e14; color: white; }
        .alert-low { background-color: #20c997; color: white; }
        .status-card { border-left: 4px solid #007bff; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .real-time-indicator { 
            width: 12px; 
            height: 12px; 
            background-color: #28a745; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 5px; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .severity-badge { font-size: 0.8em; }
        .user-risk-high { color: #dc3545; }
        .user-risk-medium { color: #fd7e14; }
        .user-risk-low { color: #28a745; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i>
                Insider Threat Detection
            </a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/">Dashboard</a>
                <a class="nav-link" href="/alerts">Alerts</a>
                <a class="nav-link" href="/users">Users</a>
                <a class="nav-link" href="/reports">Reports</a>
            </div>
            <div class="navbar-text">
                <span class="real-time-indicator"></span>
                Real-time Monitoring
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card status-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">System Status</h5>
                        <h3 id="system-status" class="text-success">
                            <i class="fas fa-check-circle"></i> Online
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Active Alerts</h5>
                        <h3 id="active-alerts" class="text-warning">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Events Today</h5>
                        <h3 id="events-today" class="text-info">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Users Monitored</h5>
                        <h3 id="users-monitored" class="text-primary">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Alert Severity Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="alertSeverityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Event Types (Last 24 Hours)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="eventTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts and Top Risk Users -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Recent Alerts</h5>
                        <a href="/alerts" class="btn btn-sm btn-primary">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>User</th>
                                        <th>Event</th>
                                        <th>Severity</th>
                                        <th>Score</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-alerts">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Top Risk Users</h5>
                    </div>
                    <div class="card-body">
                        <div id="top-risk-users">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Performance -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>System Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Events/Second:</strong>
                                <span id="events-per-second" class="text-info">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Queue Size:</strong>
                                <span id="queue-size" class="text-info">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Active Collectors:</strong>
                                <span id="active-collectors" class="text-info">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Uptime:</strong>
                                <span id="system-uptime" class="text-info">0s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Charts
        let alertSeverityChart, eventTypesChart;
        
        // Initialize charts
        function initCharts() {
            // Alert Severity Chart
            const severityCtx = document.getElementById('alertSeverityChart').getContext('2d');
            alertSeverityChart = new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#dc3545', '#fd7e14', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Event Types Chart
            const typesCtx = document.getElementById('eventTypesChart').getContext('2d');
            eventTypesChart = new Chart(typesCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Events',
                        data: [],
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Load dashboard data
        function loadDashboardData() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => updateDashboard(data))
                .catch(error => console.error('Error loading dashboard data:', error));
            
            fetch('/api/alerts?limit=10')
                .then(response => response.json())
                .then(data => updateRecentAlerts(data))
                .catch(error => console.error('Error loading alerts:', error));
            
            fetch('/api/users?limit=5')
                .then(response => response.json())
                .then(data => updateTopRiskUsers(data))
                .catch(error => console.error('Error loading users:', error));
        }
        
        // Update dashboard with new data
        function updateDashboard(data) {
            // Update system status
            if (data.processor && data.processor.active_collectors > 0) {
                document.getElementById('system-status').innerHTML = '<i class="fas fa-check-circle"></i> Online';
                document.getElementById('system-status').className = 'text-success';
            } else {
                document.getElementById('system-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline';
                document.getElementById('system-status').className = 'text-danger';
            }
            
            // Update metrics
            if (data.alerts) {
                document.getElementById('active-alerts').textContent = data.alerts.active_count || 0;
            }
            
            if (data.database) {
                document.getElementById('events-today').textContent = data.database.events_last_24h || 0;
                document.getElementById('users-monitored').textContent = data.database.user_profiles_count || 0;
            }
            
            if (data.processor) {
                document.getElementById('events-per-second').textContent = 
                    (data.processor.events_per_second || 0).toFixed(2);
                document.getElementById('queue-size').textContent = data.processor.queue_size || 0;
                document.getElementById('active-collectors').textContent = data.processor.active_collectors || 0;
                document.getElementById('system-uptime').textContent = 
                    formatUptime(data.processor.uptime_seconds || 0);
            }
            
            // Update charts
            if (data.alerts && alertSeverityChart) {
                alertSeverityChart.data.datasets[0].data = [
                    data.alerts.high_severity_count || 0,
                    data.alerts.medium_severity_count || 0,
                    data.alerts.low_severity_count || 0
                ];
                alertSeverityChart.update();
            }
        }
        
        // Update recent alerts table
        function updateRecentAlerts(alerts) {
            const tbody = document.getElementById('recent-alerts');
            tbody.innerHTML = '';
            
            if (!alerts || alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No recent alerts</td></tr>';
                return;
            }
            
            alerts.slice(0, 10).forEach(alert => {
                const row = document.createElement('tr');
                const severityClass = `alert-${alert.severity.toLowerCase()}`;
                const timeStr = new Date(alert.timestamp).toLocaleTimeString();
                
                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${alert.event.user_id || 'Unknown'}</td>
                    <td>${alert.event.event_type || 'Unknown'}</td>
                    <td><span class="badge ${severityClass}">${alert.severity}</span></td>
                    <td>${alert.anomaly_score.toFixed(3)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewAlert('${alert.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update top risk users
        function updateTopRiskUsers(users) {
            const container = document.getElementById('top-risk-users');
            container.innerHTML = '';
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p class="text-muted">No users to display</p>';
                return;
            }
            
            users.slice(0, 5).forEach(user => {
                const riskClass = user.avg_risk_score > 0.7 ? 'user-risk-high' : 
                                 user.avg_risk_score > 0.4 ? 'user-risk-medium' : 'user-risk-low';
                
                const userDiv = document.createElement('div');
                userDiv.className = 'mb-2 p-2 border rounded';
                userDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${user.user_id}</strong>
                        <span class="${riskClass}">${user.avg_risk_score.toFixed(3)}</span>
                    </div>
                    <small class="text-muted">${user.event_count} events</small>
                `;
                container.appendChild(userDiv);
            });
        }
        
        // Utility functions
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }
        
        function viewAlert(alertId) {
            window.location.href = `/alerts?id=${alertId}`;
        }
        
        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            socket.emit('subscribe_alerts');
            socket.emit('subscribe_stats');
        });
        
        socket.on('new_alert', function(alert) {
            console.log('New alert received:', alert);
            // Add animation or notification for new alert
            loadDashboardData(); // Refresh data
        });
        
        socket.on('alert_updated', function(data) {
            console.log('Alert updated:', data);
            loadDashboardData(); // Refresh data
        });
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>